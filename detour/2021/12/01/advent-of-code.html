<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <title>Advent of Code</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="/assets/css/style.css?v=2caa0aad044a3b83b4d652639794266fe94766b9">
    <link rel="stylesheet" type="text/css" href="/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://assumeforsimplicity.com/feed.xml" title="Assume For Simplicity" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Advent of Code | Assume For Simplicity</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Advent of Code" />
<meta name="author" content="jr101dallas" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Detour A friend of mine at work clued me in to Advent of Code and I’m taking a little detour on it! I started out on the first puzzle of the first day in Powershell, just for fast work and I alread had a script that was almost what I needed. But, I hit the second puzzle and realized it was a ton easier in SQL (at least t-sql SQL Server) so I went back and retrofit the first puzzle that way too." />
<meta property="og:description" content="Detour A friend of mine at work clued me in to Advent of Code and I’m taking a little detour on it! I started out on the first puzzle of the first day in Powershell, just for fast work and I alread had a script that was almost what I needed. But, I hit the second puzzle and realized it was a ton easier in SQL (at least t-sql SQL Server) so I went back and retrofit the first puzzle that way too." />
<link rel="canonical" href="https://assumeforsimplicity.com/detour/2021/12/01/advent-of-code.html" />
<meta property="og:url" content="https://assumeforsimplicity.com/detour/2021/12/01/advent-of-code.html" />
<meta property="og:site_name" content="Assume For Simplicity" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-01T09:11:34+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advent of Code" />
<script type="application/ld+json">
{"description":"Detour A friend of mine at work clued me in to Advent of Code and I’m taking a little detour on it! I started out on the first puzzle of the first day in Powershell, just for fast work and I alread had a script that was almost what I needed. But, I hit the second puzzle and realized it was a ton easier in SQL (at least t-sql SQL Server) so I went back and retrofit the first puzzle that way too.","headline":"Advent of Code","dateModified":"2021-12-01T09:11:34+00:00","datePublished":"2021-12-01T09:11:34+00:00","url":"https://assumeforsimplicity.com/detour/2021/12/01/advent-of-code.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://assumeforsimplicity.com/detour/2021/12/01/advent-of-code.html"},"author":{"@type":"Person","name":"jr101dallas"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <div id="container">
      <div class="inner">
        <nav>
    
      <a href="/" >
        Home
      </a>
    
      <a href="/posts/" >
        Posts
      </a>
    
      <a href="/breadcrumbs/" >
        Breadcrumbs
      </a>
    
      <a href="/roguelike-tutorial/" >
        Roguelike
      </a>
    
      <a href="/about/" >
        About
      </a>
    
  </nav>
        <header>
          <h1>Advent of Code</h1>
          <h2>Manage Time, Software, and Business, Easily  </h2>
        </header>
        <section id="downloads" class="clearfix">
          
	
        </section>
        <hr>
        <section id="main_content">
          <p class="view">1 December 2021 by jr101dallas</p>
<a href="/posts/">&#8672;&nbsp;Back to Posts</a>


<h1 id="detour">Detour</h1>
<p>A friend of mine at work clued me in to <a href="https://adventofcode.com/2021">Advent of Code</a> and I’m taking a little detour on it! I started out on the first puzzle of the first day in Powershell, just for fast work and I alread had a script that was almost what I needed. But, I hit the second puzzle and realized it was a ton easier in SQL (at least t-sql SQL Server) so I went back and retrofit the first puzzle that way too.</p>

<h2 id="setup">Setup</h2>
<p>So the first puzzle started right off with a sequence of values, which often screams data processing to me, but the task at hand was a little too simple. The initial task is just to get a count of when the sequence increases from the previous value. Procedural, loop the values once and keep track of the previous one, compare previous to current and increment a counter when it’s greater. Totally simple, that was why I started with Powershell.</p>

<p>The SQL way is as easy for the first puzzle. First load a table, ‘cause SQL. This does a couple of things. First, it gives us easy sort on our sequence by the <code class="language-plaintext highlighter-rouge">IDENTITY</code> column in case we need to do something squirrely later. Second, it gives us easy repeatability to mess around with different <code class="language-plaintext highlighter-rouge">SELECT</code> statements on it later. Note that I’m creating and inserting into a local temp table, scope is the connection so it cleans up when I shut down the tab in SSMS.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">measurements</span> <span class="p">(</span><span class="n">rowNumber</span> <span class="nb">BIGINT</span> <span class="k">IDENTITY</span><span class="p">,</span> <span class="n">depth</span> <span class="nb">BIGINT</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">measurements</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">t</span><span class="p">.</span><span class="n">depth</span>
<span class="k">from</span> <span class="p">(</span>
	<span class="k">VALUES</span><span class="p">(</span><span class="mi">190</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">168</span><span class="p">),</span>
        <span class="p">...</span>
        <span class="p">(</span><span class="mi">4482</span><span class="p">)</span>
<span class="p">)</span> <span class="n">t</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
</code></pre></div></div>

<p>The first puzzle then, retrofit to SQL, gets a solution like this. A Common Table Expression (CTE) lets us set up a few columns so we can easily see what’s happening. Once you take a look, you’ll probably see why the SQL solution wasn’t the first one I went to. This is technically a tricky use of a degenerate case for a windowing function. The window in the PreviousValue column is from the preceding row to the preceding row. Likewise, CurrentValue has a window of the current row to the current row. Summing the windows of values trivially returns the value itself. That makes DiffOfValues a simple subtraction of the preceding value from the current value.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">cte</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">rowNumber</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> 
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">PreviousValue</span><span class="p">,</span>
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="k">CURRENT</span> <span class="k">ROW</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span><span class="p">)</span> <span class="k">AS</span> <span class="n">CurrentValue</span><span class="p">,</span>
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="k">CURRENT</span> <span class="k">ROW</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span><span class="p">)</span> 
            <span class="o">-</span> <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DiffOfValues</span>
    <span class="k">FROM</span> <span class="o">#</span><span class="n">measurements</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
	<span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfValues</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="n">DiffOfValues</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Zeroes</span><span class="p">,</span>
	<span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfValues</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="n">DiffOfValues</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Increases</span><span class="p">,</span>
	<span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfValues</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="n">DiffOfValues</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Decreases</span>
<span class="k">FROM</span> <span class="n">cte</span>
</code></pre></div></div>

<p>Once I have the sequence of differences, I select from the CTE to split out my cases and count them.</p>

<h2 id="backwards">Backwards</h2>
<p>The degenerate case and the convoluted thinking of that solution, even though fairly simple, was much easier to get to from the solution to the second puzzle. Working backwards is sometimes way easier. The setup for the second puzzle actually suggests a rolling window, a classic use case for windowing functions, in this case to smooth out the data curve and see the trend in depth better. That solution looks much like the one above but more “normal looking” for the windowing functions.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">cte</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">rowNumber</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> 
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">2</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span><span class="p">)</span> <span class="k">AS</span> <span class="n">SumTwoBefore</span><span class="p">,</span>
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">SumBeforeAndAfter</span><span class="p">,</span>
        <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span><span class="p">)</span> 
            <span class="o">-</span> <span class="k">SUM</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowNumber</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">2</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DiffOfSums</span>
    <span class="k">FROM</span> <span class="o">#</span><span class="n">measurements</span>
<span class="p">)</span>
<span class="p">,</span> <span class="n">detection</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">select</span> <span class="o">*</span><span class="p">,</span> 
        <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfSums</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="s1">'no change'</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span> <span class="k">AS</span> <span class="n">Zeroes</span><span class="p">,</span>
        <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfSums</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="s1">'increased'</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span> <span class="k">AS</span> <span class="n">Increases</span><span class="p">,</span>
        <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DiffOfSums</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="s1">'decreased'</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span> <span class="k">AS</span> <span class="n">Decreases</span>
    <span class="k">from</span> <span class="n">cte</span> 
    <span class="k">where</span> <span class="n">rwnm</span> <span class="k">between</span> <span class="mi">3</span> <span class="k">AND</span> <span class="mi">1999</span>
<span class="p">)</span>
<span class="k">select</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">Zeroes</span><span class="p">)</span> <span class="k">as</span> <span class="n">Zeroes</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">Increases</span><span class="p">)</span> <span class="k">as</span> <span class="n">Increases</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">Decreases</span><span class="p">)</span> <span class="k">as</span> <span class="n">Decreases</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">AS</span> <span class="n">AllOfThem</span>
<span class="k">from</span> <span class="n">detection</span>
</code></pre></div></div>

<p>Here we can see the normal windowing, two rows preceding to the current row and one row preceding to one row following. The subtraction is the same. The second CTE is where things get slightly more interesting, we need a where clause to exclude the rows where the calculation is invalid, the first two rows and the final row. In the previous puzzle, this also collapses to a simpler case and I directly nest the case statements in the count statements.</p>

<p>And that was day one.</p>



  <small>tags: <em>code</em> - <em>sql</em> - <em>fun</em></small>


<p>
  <div class="post-nav">
    <p>
      
      <a href="/roguelike/2021/11/30/collision.html">&#8672;&nbsp;Collision</a>
      
    </p>
    <p>
      
      <a href="/detour/2021/12/02/detour.html">Detour&nbsp;&#8674;</a>
      
    </p>
  </div>
</p>
        </section>

        <footer>
        
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

      </div>
    </div>

    
  </body>
</html>