<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <title>2d Height Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <link rel="stylesheet" type="text/css" href="/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://assumeforsimplicity.com/feed.xml" title="Assume For Simplicity" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>2d Height Map | Assume For Simplicity</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="2d Height Map" />
<meta name="author" content="jr101dallas" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ooch! The data for this one is a 100 x 100 height map. There is no way I’m doing this as a 100 column table. That would be a pain as well as awkward and ludicrous. But, now I have to figure out what I am going to do. Really, I think where I need to go is a three-ish column table of x, y, height so that I can do some windowing function magic. I’m not positive that’s a perfect way to go, because there’s so logic there that I’m not 100% sure how to pull off, but I’ve definitely got to get the data parsed and into the database first. I could cheat and say that the SQL doesn’t start till the data is in the database (I did already do some of that with some regex data formatting) but I’m really aiming for actual SQL solutions so I’m going to try avoiding that." />
<meta property="og:description" content="Ooch! The data for this one is a 100 x 100 height map. There is no way I’m doing this as a 100 column table. That would be a pain as well as awkward and ludicrous. But, now I have to figure out what I am going to do. Really, I think where I need to go is a three-ish column table of x, y, height so that I can do some windowing function magic. I’m not positive that’s a perfect way to go, because there’s so logic there that I’m not 100% sure how to pull off, but I’ve definitely got to get the data parsed and into the database first. I could cheat and say that the SQL doesn’t start till the data is in the database (I did already do some of that with some regex data formatting) but I’m really aiming for actual SQL solutions so I’m going to try avoiding that." />
<link rel="canonical" href="https://assumeforsimplicity.com/detour/2021/12/11/2d-height-map.html" />
<meta property="og:url" content="https://assumeforsimplicity.com/detour/2021/12/11/2d-height-map.html" />
<meta property="og:site_name" content="Assume For Simplicity" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-11T09:11:34+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="2d Height Map" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"jr101dallas"},"description":"Ooch! The data for this one is a 100 x 100 height map. There is no way I’m doing this as a 100 column table. That would be a pain as well as awkward and ludicrous. But, now I have to figure out what I am going to do. Really, I think where I need to go is a three-ish column table of x, y, height so that I can do some windowing function magic. I’m not positive that’s a perfect way to go, because there’s so logic there that I’m not 100% sure how to pull off, but I’ve definitely got to get the data parsed and into the database first. I could cheat and say that the SQL doesn’t start till the data is in the database (I did already do some of that with some regex data formatting) but I’m really aiming for actual SQL solutions so I’m going to try avoiding that.","url":"https://assumeforsimplicity.com/detour/2021/12/11/2d-height-map.html","@type":"BlogPosting","headline":"2d Height Map","dateModified":"2021-12-11T09:11:34+00:00","datePublished":"2021-12-11T09:11:34+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://assumeforsimplicity.com/detour/2021/12/11/2d-height-map.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <div id="container">
      <div class="inner">
        <nav>
    
      <a href="/" >
        Home
      </a>
    
      <a href="/posts/" >
        Posts
      </a>
    
      <a href="/breadcrumbs/" >
        Breadcrumbs
      </a>
    
      <a href="/roguelike-tutorial/" >
        Roguelike
      </a>
    
      <a href="/about/" >
        About
      </a>
    
  </nav>
        <header>
          <h1>2d Height Map</h1>
          <h2>Manage Time, Software, and Business, Easily  </h2>
        </header>
        <section id="downloads" class="clearfix">
          
	
        </section>
        <hr>
        <section id="main_content">
          <p class="view">11 December 2021 by jr101dallas</p>
<a href="/posts/">&#8672;&nbsp;Back to Posts</a>


<h1 id="ooch">Ooch!</h1>
<p>The data for this one is a 100 x 100 height map. There is no way I’m doing this as a 100 column table. That would be a pain as well as awkward and ludicrous. But, now I have to figure out what I am going to do. Really, I think where I need to go is a three-ish column table of x, y, height so that I can do some windowing function magic. I’m not positive that’s a perfect way to go, because there’s so logic there that I’m not 100% sure how to pull off, but I’ve definitely got to get the data parsed and into the database first. I could cheat and say that the SQL doesn’t start till the data is in the database (I did already do some of that with some regex data formatting) but I’m really aiming for actual SQL solutions so I’m going to try avoiding that.</p>

<h2 id="data-processing">Data Processing</h2>
<p>So, if I want to set this up for an arbitrarily large data set, which for at least some of the puzzles I have definitely only engineered a solution for the specific size of the set, then I would need to do something like the following.</p>

<ol>
  <li>assuming possibly very large rows, I would have to plan for chunking, so I need a row number value independent of the identity column</li>
  <li>I still need identity for sort within that row number grouping unless I create an independent row segment number</li>
  <li>I could go really big chunks with NVARCHAR(MAX) but might have to decide that after I plan out the row parsing logic</li>
  <li>row parsing would need to create output of row number, easy from the field in the table, character number which isn’t as easy, and the value of the character</li>
</ol>

<p>Working backwards then, my data insert is really easy if I can figure out the row parsing. That’s where to start then.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">ALTER</span> <span class="k">FUNCTION</span> <span class="n">LineParser</span><span class="p">(</span><span class="o">@</span><span class="k">Row</span> <span class="nb">INT</span><span class="p">,</span> <span class="o">@</span><span class="n">RowColumnString</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">))</span>
<span class="k">RETURNS</span> <span class="k">TABLE</span>
<span class="k">RETURN</span>
<span class="k">WITH</span> <span class="k">input</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span> <span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">RowColumnString</span><span class="p">)</span> <span class="k">AS</span> <span class="n">charLen</span>
<span class="p">)</span>
<span class="p">,</span> <span class="n">limiter</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span> <span class="n">val</span> <span class="k">AS</span> <span class="n">col</span>
	<span class="k">FROM</span> <span class="n">Numbers</span> <span class="n">n</span>
	<span class="k">WHERE</span> <span class="n">n</span><span class="p">.</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">charLen</span> <span class="k">FROM</span> <span class="k">input</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
	<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">NULL</span><span class="p">))</span> <span class="k">AS</span> <span class="n">GroupIdentity</span><span class="p">,</span>
	<span class="o">@</span><span class="k">Row</span> <span class="k">AS</span> <span class="n">MapRowNum</span><span class="p">,</span>
	<span class="n">ca</span><span class="p">.</span><span class="n">CharAtCol</span>
<span class="k">FROM</span> <span class="n">limiter</span> <span class="n">l</span>
<span class="k">CROSS</span> <span class="n">APPLY</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">SUBSTRING</span> <span class="p">(</span><span class="o">@</span><span class="n">RowColumnString</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">col</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">CharAtCol</span><span class="p">)</span> <span class="n">ca</span>
<span class="k">GO</span>

<span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">LineParser</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'6543467789865478999899865439123998965323234569549878542987632459976989457993567987542196569879210145'</span><span class="p">)</span>
</code></pre></div></div>

<p>That was easier than I was thinking, now I just have to insert data and then transform it into my working table.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">HeightMapRaw</span> <span class="p">(</span><span class="n">id</span> <span class="nb">BIGINT</span> <span class="k">IDENTITY</span><span class="p">,</span> <span class="n">MapRow</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">HeightMapRaw</span> <span class="p">(</span><span class="n">MapRow</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">MapRow</span>
<span class="k">FROM</span> <span class="p">(</span>
<span class="k">VALUES</span><span class="p">(</span><span class="s1">'6769876887698999876367898543212378997654321291098765432398767667989976543210123456987678999766598921'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'5456965476567999985457897654301456989743210989989898540987656545678987654323634679876569998757387892'</span><span class="p">),</span>
<span class="p">...</span>
<span class="p">(</span><span class="s1">'4345896595432124588998765545987674567899999876345987658987659767896431239109876543456789432101299965'</span><span class="p">)</span>
<span class="p">)</span> <span class="n">t</span><span class="p">(</span><span class="n">MapRow</span><span class="p">)</span>

<span class="k">SELECT</span> 
	<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">GroupIdentity</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DatumId</span><span class="p">,</span>
	<span class="n">m</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">MapRow</span><span class="p">,</span>
	<span class="n">ca</span><span class="p">.</span><span class="n">GroupIdentity</span> <span class="k">AS</span> <span class="n">MapColumn</span><span class="p">,</span>
	<span class="n">ca</span><span class="p">.</span><span class="n">CharAtCol</span> <span class="k">AS</span> <span class="n">Height</span>
<span class="k">INTO</span> <span class="n">HeightMap</span>
<span class="k">FROM</span> <span class="n">HeightMapRaw</span> <span class="n">m</span>
<span class="k">CROSS</span> <span class="n">APPLY</span> <span class="n">dbo</span><span class="p">.</span><span class="n">LineParser</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">MapRow</span><span class="p">)</span> <span class="n">ca</span>
</code></pre></div></div>

<p>Now I have a table HeightMap with my x, y coordinates and height values that I should be able to use my windoing functions on. There might be some funny business around getting only the orthogonal map coordinates but I’m not completely sure yet.</p>

<h2 id="puzzle-one">Puzzle One</h2>
<p>Finding the local minima works out to the following query. I had to add the maximimum calculations because I originally wasn’t accounting for a totally flat three by three area (really in this case a flat plus sign) or part of one on the edge, and I have a blocks of nines like that in my data. The example didn’t really say what to do in a case like that, but the answer I tried first was too high and so I went looking for edge cases.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">calculateLocalMins</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> 
		<span class="k">MIN</span><span class="p">(</span><span class="n">Height</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">MapColumn</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">MapRow</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">LocalMinRow</span><span class="p">,</span> 
		<span class="k">MIN</span><span class="p">(</span><span class="n">Height</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">MapRow</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">MapColumn</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">LocalMinColumn</span><span class="p">,</span> 
		<span class="k">MAX</span><span class="p">(</span><span class="n">Height</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">MapColumn</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">MapRow</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">LocalMaxRow</span><span class="p">,</span> 
		<span class="k">MAX</span><span class="p">(</span><span class="n">Height</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">MapRow</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">MapColumn</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">LocalMaxColumn</span>
	<span class="k">FROM</span> <span class="n">HeightMap</span>
<span class="p">)</span>
<span class="p">,</span> <span class="n">filterLocalMins</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="n">Height</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="n">RiskFactor</span> 
<span class="k">FROM</span> <span class="n">calculateLocalMins</span>
<span class="k">WHERE</span> <span class="n">LocalMinRow</span> <span class="o">=</span> <span class="n">Height</span>
	<span class="k">AND</span> <span class="n">LocalMinColumn</span> <span class="o">=</span> <span class="n">Height</span>
	<span class="k">AND</span> <span class="n">LocalMaxRow</span> <span class="o">!=</span> <span class="n">Height</span>
	<span class="k">AND</span> <span class="n">LocalMaxColumn</span> <span class="o">!=</span> <span class="n">Height</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="n">RiskFactor</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">filterLocalMins</span>
</code></pre></div></div>

<h2 id="puzzle-two">Puzzle Two</h2>
<p>Locating basins. Uh oh. I’m not sure my code is set up for this. Nines don’t count as part of a basin, and the contiguous group of numbers surrounded by nines is a basin. Find the three largest basins and the count of the locations in them, and multiply the three together.</p>

<p>First, I’m thinking that maybe I should just go looking on google for ways to tackle this problem. Second, I’m thinking that the easy visual identification method that keeps running through my head is getting in the way of thinking of a decent programmatic way of doing it.</p>

<p>First lets think of how to do it at all and then later I’ll figure out if or how to do it in SQL. If I start with finding pieces of a basin in a row, I can keep track of the position in the row and create a new array of locations when I find a non-nine value. I add the position of that value to the new array and move on to the next position in the row. If it is also non-nine, I keep adding the positions to the array. When I hit a nine I know to close that array for now and I wait for the next non-nine to create the next array.</p>

<p>Between rows, when I find a non-nine value I can check the current position in the row against the same position in the previous row to see if this basin is part of a previously encountered basin. For a case where the basin is narrower in the current row thsn the last row, i.e the first position of the basin in the previous row is in a position further along the row than the first position in this row, I’ll have already started a new basin array and I’ll need to be able to merge my new array into the previously existing basin. It would look something like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9993456
9876567
</code></pre></div></div>

<p>While processing the first row, I create a basin array when I hit the three in the fourth position. Then, while processing the second row, I hit the eight in the second position, check if there’s a basin to connect it to in the previous row, decide there isn’t, and start a second basin. But then when I get to the fourth position, still working on adding to my second basin, I discover that this is actually the same basin as a previous one and I need to merge them.</p>

<p>All of that said, I think I have a way forward at least RBAR even if I can’t find a way to do this regular database-wise.</p>

<p>Nope. Stuck and thinking about it. I’ve got an answer, but it’s wrong and I’m going to have to start looking for where the bug is or switch languages again. I’ll skip to the other puzzles for a while and see if I can’t come back to this later.</p>



  <small>tags: <em>code</em> - <em>sql</em> - <em>fun</em></small>


<p>
  <div class="post-nav">
    <p>
      
      <a href="/detour/2021/12/10/bad-wiring.html">&#8672;&nbsp;Bad Wiring</a>
      
    </p>
    <p>
      
      <a href="/business/2022/01/01/staerting-over.html">Starting Over&nbsp;&#8674;</a>
      
    </p>
  </div>
</p>
        </section>

        <footer>
        
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

      </div>
    </div>

    
  </body>
</html>